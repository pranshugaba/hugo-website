{{ $images := (.Context.Page.Resources.Match (printf "%s/*.{jpg,jpeg,png}" .Directory)) }}
{{ $showCoords := .ShowCoords }}
{{ with $images}}
    {{ range . }}
    <figure class="gallery__figure">
        {{ $big := "" }}
        {{ if lt .Height .Width }}
        {{ $big = .Resize "1920x" }}
        {{ else }}
        {{ $big = .Resize "x1920" }}
        {{ end }}
        {{ if $showCoords }}
            {{ with .Exif }}
                <div class="gallery__metadata">
                    {{ with .Tags.DateTimeOriginal }}
                        <div class="gallery__datetime">
                            {{ dateFormat "2006-01-02 15:04" . }}
                        </div>
                    {{ end }}
                    {{ if .Lat }}
                    <div class="gallery__coords">
                        <a href="https://www.openstreetmap.org/?mlat={{ .Lat }}&mlon={{ .Long }}#map=16/{{ .Lat }}/{{ .Long }}&layers=N" rel="noopener" target="_blank">({{ lang.NumFmt 3 .Lat }}°, {{ lang.NumFmt 3 .Long }}°)</a> 
                    </div>
                    {{ end }}
                </div>
            {{ end }}
        {{ end }}
        <img
        src="{{ $big.Permalink }}"
        {{ $altFile := (printf "%s%s" .RelPermalink ".alt")}}
        alt="{{ $altFile | readFile }}"
        height="{{ $big.Height }}"
        width="{{ $big.Width }}"
        />
        {{ $captionFile := (printf "%s%s" .RelPermalink ".caption")}}
        {{ $caption := $captionFile | readFile | markdownify }}
        {{ with $caption }}
            <div class="gallery__caption">
                <figcaption>
                    {{ if not ( findRE "<[h|p][^>]*>" . ) }}
                        <p>{{ . }}</p>
                    {{ else }}
                        {{ . }}
                    {{ end }}
                </figcaption>
            </div>
        {{ end }}
    </figure>
    {{ end }}
{{ end }}